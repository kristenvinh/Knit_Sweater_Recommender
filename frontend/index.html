<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweater Recommender</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* Simple spinner animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, .1);
            border-left-color: #4f46e5; /* indigo-600 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-50 h-full font-sans antialiased">
    <div class="flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-4xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
                <h1 class="text-2xl font-bold text-gray-900">
                    Knitwear Pattern Recommender
                </h1>
                <p class="text-sm text-gray-600">
                    This project was created by Kristen Vinh in 2025 as part of her Rochester Institute of Technology MS in Data Science capstone course to develop an algorithm that could recommend knitting sweater patterns from a user-uploaded photo.
                </p>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto max-w-4xl p-4 sm:p-6 lg:p-8">
            
            <!-- Upload Section -->
            <section id="upload-section" class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Upload Your Image</h2>
                <p class="text-sm text-gray-600 mb-4">For best results, upload an image that is a straight-on view of the sweater, clear (not pixelated), and with good lighting.</p>
                <div class="flex flex-col sm:flex-row sm:items-start sm:space-x-6">
                    <!-- File Input -->
                    <div class="flex-shrink-0">
                        <label for="file-input" class="cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                            <span>Choose a file</span>
                            <input id="file-input" name="file-input" type="file" class="sr-only" accept="image/*">
                        </label>
                    </div>
                    
                    <!-- Image Preview -->
                    <div class="mt-4 sm:mt-0 sm:flex-grow">
                        <img id="image-preview" src="https://placehold.co/600x400/e2e8f0/94a3b8?text=Your+Image+Preview" alt="Image preview" class="w-full max-w-md rounded-lg object-cover bg-gray-100 hidden">
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="mt-6 text-right">
                    <button id="submit-btn" type="button" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-gray-400" disabled>
                        Get Recommendations
                    </button>
                </div>
            </section>

            <!-- Loading Spinner -->
            <section id="loading-spinner" class="mt-8 flex justify-center items-center p-12 bg-white rounded-lg shadow hidden">
                <div class="flex flex-col items-center">
                    <div class="spinner"></div>
                    <p class="mt-4 text-gray-600">Finding patterns... this may take a moment.</p>
                </div>
            </section>

            <!-- Results Container (Holds BOTH XAI and Recommendations) -->
            <div id="results-container" class="mt-8 hidden">
                <!-- XAI Heatmap Section -->
                <section id="xai-section" class="bg-white p-6 rounded-lg shadow hidden">
                    <h2 class="text-lg font-semibold text-gray-900 mb-2">
                        Imaging Processing Explanation
                    </h2>
                    <p class="text-sm text-gray-600 mb-4">
                        The code for this project first attempts to crop your image to the person's torso to obtain a picture of just the sweater, and then removes the background using YOLO from <a href="https://docs.ultralytics.com/">Ultralytics</a>; however, this is not always successful.</p> 

<p class="text-sm text-gray-600 mb-4">It then extracts features using a DinoV2 advanced computer vision model from <a href="https://dinov2.metademolab.com/">Meta AI</a>. Below, you can see a visual representation of the crop, background removal, and feature extraction, with the red areas indicating the features the model focused on.</p>

<p class="text-sm text-gray-600 mb-4">If the crop failed and/or the red areas are focused on irrelevant features (such as hair, pants, or the person's pose), and the recommendations below are poor, consider uploading a new image.</p>

                    </p>
                    <div class="flex justify-center">
                        <img id="xai-image" src="" alt="XAI Heatmap" class="max-w-full sm:max-w-lg rounded-lg shadow-md bg-gray-100">
                    </div>
                </section>


                <!-- Recommendations Section -->
                <section id="recommendations-section" class="mt-8 bg-white p-6 rounded-lg shadow">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        Top Ten Recommendations
                    </h2>
                    <p class="text-sm text-gray-600 mb-4">Below are the top 10 recommendations that best match your sweater upload, drawn from approximately 10,000 of the top adult knitwear patterns on Ravelry using an <a href="https://github.com/nmslib/hnswlib">HNSWlib Approximate Nearest Neighbors Index</a>.</p>

<p class="text-sm text-gray-600 mb-4">Click through on any given recommendation to view the pattern on <a href ="https://www.ravelry.com/">Ravelry</a>. 
</p>
                    <!-- Results Grid -->
                    <div id="results-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        <!-- Recommendation cards will be injected here by JavaScript -->
                    </div>
                </section>

            </div>

        </main>

        <!-- Footer -->
        <footer class="bg-gray-100 border-t border-gray-200 mt-12">
            <div class="max-w-4xl mx-auto py-4 px-4 text-center text-sm text-gray-500">
                Sweater Recommender Project
            </div>
        </footer>
    </div>

    <script>
        // Get all the DOM elements we need
        const fileInput = document.getElementById('file-input');
        const imagePreview = document.getElementById('image-preview');
        const submitBtn = document.getElementById('submit-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        
        // Main container for all results
        const resultsContainer = document.getElementById('results-container');
        
        // --- NEW --- Get the XAI elements
        const xaiSection = document.getElementById('xai-section');
        const xaiImage = document.getElementById('xai-image');

        // Recommendations grid
        const resultsGrid = document.getElementById('results-grid');

        // --- 1. Handle File Input Change ---
        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (file) {
                // Create a URL for the file to use as a preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);

                // Enable the submit button
                submitBtn.disabled = false;
                
                // --- NEW --- Hide old results when a new file is chosen
                resultsContainer.classList.add('hidden');
                xaiSection.classList.add('hidden');
                resultsGrid.innerHTML = '';
            } else {
                // No file, reset
                imagePreview.classList.add('hidden');
                submitBtn.disabled = true;
            }
        });

        // --- 2. Handle Form Submission ---
        submitBtn.addEventListener('click', handleSubmit);

        async function handleSubmit() {
            const file = fileInput.files[0];
            if (!file) {
                alert("Please select a file first.");
                return;
            }

            // Create FormData to send the file
            const formData = new FormData();
            formData.append('file', file);

            // Set UI to loading state
            submitBtn.disabled = true;
            loadingSpinner.classList.remove('hidden');
            resultsContainer.classList.add('hidden');
            xaiSection.classList.add('hidden'); // --- NEW --- Hide XAI section
            resultsGrid.innerHTML = ''; // Clear old results

            try {
                // Call your FastAPI backend
                const response = await fetch('http://127.0.0.1:8000/recommend', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // --- DEBUGGING: Log the entire response ---
                console.log("Received data from backend:", data);

                // --- NEW --- Handle the XAI Heatmap
                if (data.xai_heatmap_base64) {
                    // Set the image source to the Base64 string
                    xaiImage.src = `data:image/jpeg;base64,${data.xai_heatmap_base64}`;
                    // Show the XAI section
                    xaiSection.classList.remove('hidden');
                } else {
                    // --- DEBUGGING: Tell us if the heatmap is missing ---
                    console.log("No XAI heatmap was returned from the backend (data.xai_heatmap_base64 is null or empty).");
                    xaiSection.classList.add('hidden');
                }

                // Handle the Recommendations
                if (data.recommendations && data.recommendations.length > 0) {
                    let html = '';
                    data.recommendations.forEach(item => {
                        // Use a placeholder if thumbnail is missing
                        const imgSrc = item.thumbnail || `https://placehold.co/300x300/e2e8f0/94a3b8?text=${encodeURIComponent(item.name || 'Pattern')}`;
                        
                        html += `
                            <a href="${item.url || '#'}" target="_blank" rel="noopener noreferrer" class="block group rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-shadow duration-300">
                                <img src="${imgSrc}" alt="Pattern ${item.name}" class="w-full h-48 object-cover">
                                <div class="p-3">
                                    <p class="text-sm font-medium text-gray-900 truncate group-hover:text-indigo-600">${item.name || 'Untitled Pattern'}</p>
                                </div>
                            </a>
                        `;
                    });
                    resultsGrid.innerHTML = html;
                } else {
                    resultsGrid.innerHTML = '<p class="text-gray-500 col-span-full">No recommendations found.</p>';
                }

                // Show the main results container (which holds both XAI and grid)
                resultsContainer.classList.remove('hidden');

            } catch (error) {
                console.error('Error during fetch:', error);
                resultsGrid.innerHTML = `<p class="text-red-500 col-span-full">An error occurred: ${error.message}. Check the console and server logs.</p>`;
                resultsContainer.classList.remove('hidden'); // Show container to display error
                xaiSection.classList.add('hidden'); // --- NEW --- Hide XAI on error
            } finally {
                // Always re-enable button and hide spinner
                submitBtn.disabled = false;
                loadingSpinner.classList.add('hidden');
            }
        }
    </script>
</body>
</html>